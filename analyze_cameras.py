#!/usr/bin/env python3
"""分析Waymo 5个相机的布局"""

import numpy as np

# 外参矩阵 (cam to vehicle)
extrinsics = {
    0: np.array([
        [-4.588266398430291063e-03, -3.413667297520365119e-03, 9.999836472098125872e-01, 1.544154267170511075e+00],
        [-9.999632354307952387e-01, -7.228375769820964344e-03, -4.612848415714690224e-03, -2.315740942895095494e-02],
        [7.244004295493749329e-03, -9.999680482191979358e-01, -3.380376081852865672e-03, 2.115612062706179408e+00],
        [0, 0, 0, 1]
    ]),
    1: np.array([
        [7.005018364965225341e-01, 1.403340716065310488e-02, 7.135126071405204495e-01, 1.496389687213992348e+00],
        [-7.134812768348982592e-01, -8.006471824671627241e-03, 7.006285492434377593e-01, 9.523088838759638519e-02],
        [1.554492428552942812e-02, -9.998694714273379525e-01, 4.404025042286640983e-03, 2.115469210762333852e+00],
        [0, 0, 0, 1]
    ]),
    2: np.array([
        [-7.017169504081365305e-01, -1.394784848339474838e-02, 7.123192957042432383e-01, 1.494620668658753759e+00],
        [7.122952778659862839e-01, 6.207696702890645153e-03, 7.018359917831663612e-01, -1.035823408886936677e-01],
        [-1.001099664460622932e-02, 9.998787878816997994e-01, 1.198303912074607994e-02, 2.116054729690339817e+00],
        [0, 0, 0, 1]
    ]),
    3: np.array([
        [9.999677939340467780e-01, 3.714921476318800743e-03, 7.114102410047218154e-03, 1.431745497324498517e+00],
        [-7.117626063726789756e-03, -1.059085943555612085e-02, 9.999177026821172564e-01, 5.765368864488887302e-01],
        [3.703020341062906551e-03, -9.999369824899169966e-01, -1.059459853060042896e-02, 2.116032821965595923e+00],
        [0, 0, 0, 1]
    ]),
    4: np.array([
        [-9.999830676219401138e-01, 1.199549220653473849e-03, -5.694343779711691193e-03, 1.429610406263754463e+00],
        [5.703277732943557062e-03, 7.580869201243316778e-03, -9.999550005101502936e-01, -1.159021192501086955e-01],
        [-1.156327166169586950e-03, -9.999705453181212400e-01, -7.587582201459702053e-03, 2.115839645136969871e+00],
        [0, 0, 0, 1]
    ])
}

# 内参 (fx, fy, cx, cy, ...)
intrinsics = {
    0: [2084.604, 2084.604, 933.407, 665.022],
    1: [2079.596, 2079.596, 1011.360, 630.213],
    2: [2086.823, 2086.823, 929.690, 669.932],
}

print("="*60)
print("Waymo 相机布局分析")
print("="*60)

for cam_id, ext in extrinsics.items():
    R = ext[:3, :3]
    t = ext[:3, 3]

    # 计算旋转角度 (绕Z轴，yaw角)
    yaw = np.arctan2(R[1, 0], R[0, 0]) * 180 / np.pi

    # 前视方向 (相机Z轴在世界坐标系的方向)
    forward = R[:, 2]

    print(f"\nCAM{cam_id}:")
    print(f"  位置(xyz): ({t[0]:.3f}, {t[1]:.3f}, {t[2]:.3f})m")
    print(f"  Yaw角度: {yaw:.1f}°")
    print(f"  前视方向: ({forward[0]:.3f}, {forward[1]:.3f}, {forward[2]:.3f})")

    if cam_id in intrinsics:
        fx, fy, cx, cy = intrinsics[cam_id]
        fov_h = 2 * np.arctan(cx / fx) * 180 / np.pi
        fov_v = 2 * np.arctan(cy / fy) * 180 / np.pi
        print(f"  焦距(fx,fy): ({fx:.1f}, {fy:.1f})")
        print(f"  FOV(H×V): {fov_h:.1f}° × {fov_v:.1f}°")

print("\n" + "="*60)
print("相机间角度差")
print("="*60)

def get_yaw(R):
    return np.arctan2(R[1, 0], R[0, 0]) * 180 / np.pi

yaws = {i: get_yaw(extrinsics[i][:3, :3]) for i in range(5)}

print(f"CAM0 → CAM1: {yaws[1] - yaws[0]:.1f}°")
print(f"CAM0 → CAM2: {yaws[2] - yaws[0]:.1f}°")
print(f"CAM0 → CAM3: {yaws[3] - yaws[0]:.1f}°")
print(f"CAM0 → CAM4: {yaws[4] - yaws[0]:.1f}°")
